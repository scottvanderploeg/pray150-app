{% extends "base.html" %}

{% block title %}Dashboard - Pray150{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 fw-bold mb-2">Welcome back, {{ current_user.display_name }}!</h1>
                    <p class="text-muted">Let's continue your prayer journey with God's Word</p>
                </div>
                {% if current_user.is_admin %}
                <div>
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-2"></i>Admin Panel
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Next Psalm Card -->
    {% if current_psalm_api or current_psalm %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm today-psalm-card">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-arrow-right" style="color: #E93C02;" me-2></i>
                                <small class="text-muted">Next Psalm</small>
                            </div>
                            
                            {% if current_psalm_api %}
                                <h3 class="h4 fw-bold mb-2" style="color: #333E4D;">
                                    Psalm {{ current_psalm_api.psalm_number }}
                                    <span class="badge ms-2" style="background-color: #D1AEA9; color: #333E4D;">{{ current_psalm_api.translation }}</span>
                                </h3>
                                <p class="text-muted mb-3">
                                    {% if current_psalm_api.verses and current_psalm_api.verses|length > 0 %}
                                        {{ current_psalm_api.verses[0].text[:150] }}...
                                    {% endif %}
                                </p>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('main.pre_reflection', psalm_number=current_psalm_api.psalm_number) }}" 
                                       class="btn btn-primary" style="background-color: #E93C02; border-color: #E93C02;">
                                        <i class="fas fa-book-open me-2"></i>Read & Pray
                                    </a>
                                    <span class="small text-muted align-self-center">
                                        {{ current_psalm_api.verse_count }} verses â€¢ Live Bible API
                                    </span>
                                </div>
                            {% elif current_psalm %}
                                <h3 class="h4 fw-bold mb-2" style="color: #333E4D;">Psalm {{ current_psalm.number }}: {{ current_psalm.title }}</h3>
                                <p class="text-muted mb-3">
                                    {% if current_psalm.text_niv %}
                                        {{ current_psalm.text_niv[:150] }}...
                                    {% endif %}
                                </p>
                                <a href="{{ url_for('main.pre_reflection', psalm_number=current_psalm.number) }}" 
                                   class="btn btn-primary" style="background-color: #E93C02; border-color: #E93C02;">
                                    <i class="fas fa-book-open me-2"></i>Read & Pray
                                </a>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="psalm-number-display">
                                <div class="psalm-number" style="color: #333E4D; font-size: 3rem; font-weight: bold;">
                                    {{ current_psalm_api.psalm_number if current_psalm_api else current_psalm.number }}
                                </div>
                                <small class="text-muted">of 150</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Psalm Navigator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header" style="background-color: #B5B9C4; border: none;">
                    <h3 class="mb-0" style="color: #333E4D;">
                        <i class="fas fa-list me-2"></i>Explore Psalms
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text" style="background-color: #D1AEA9; border-color: #D1AEA9;">
                                    <i class="fas fa-book"></i>
                                </span>
                                <select class="form-select" id="psalmSelector" onchange="navigateToPsalm()">
                                    <option value="">Choose a Psalm to read...</option>
                                    {% for i in range(1, 151) %}
                                    <option value="{{ i }}" {% if current_psalm_api and i == current_psalm_api.psalm_number %}selected{% endif %}>
                                        Psalm {{ i }}{% if i == (current_psalm_api.psalm_number if current_psalm_api else current_psalm_number) %} (Next Psalm){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="btn" style="background-color: #E93C02; color: white;" onclick="navigateToPsalm()">
                                    <i class="fas fa-arrow-right"></i> Go
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <!-- Removed Bible API Demo button - link now in footer -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-0 h-100 stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-book fa-2x text-primary"></i>
                    </div>
                    <h4 class="fw-bold mb-1">{{ total_psalms_read }}</h4>
                    <p class="text-muted mb-0">Psalms Completed</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 h-100 stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-fire fa-2x text-warning"></i>
                    </div>
                    <h4 class="fw-bold mb-1">{{ psalms_this_week }}</h4>
                    <p class="text-muted mb-0">This Week</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-0 h-100 stat-card">
                <div class="card-body text-center">
                    <div class="stat-icon mb-2">
                        <i class="fas fa-hands fa-2x text-success"></i>
                    </div>
                    <h4 class="fw-bold mb-1">{{ total_journal_entries }}</h4>
                    <p class="text-muted mb-0">Journal Entries</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Heart Tracker Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-heart text-danger me-2"></i>
                        Heart Tracker
                    </h5>
                    <small class="text-muted">Track your emotional journey through prayer and reflection</small>
                </div>
                <div class="card-body">
                    {% if emotion_trends_week or emotion_trends_month %}
                    <!-- This Week Chart -->
                    <div class="mb-5">
                        <h6 class="fw-bold mb-3">This Week</h6>
                        <div class="chart-container" style="height: 250px; padding: 10px;">
                            <canvas id="weekChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- This Month Chart -->
                    <div class="mb-5">
                        <h6 class="fw-bold mb-3">This Month</h6>
                        <div class="chart-container" style="height: 250px; padding: 10px;">
                            <canvas id="monthChart"></canvas>
                        </div>
                    </div>
                    
                    
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-heart fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-3">No emotion data yet.</p>
                        <p class="small text-muted">Complete journal entries with emotion check-ins to see your heart journey.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Recent Journal Entries -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-journal-whills text-primary me-2"></i>
                            Recent Journal Entries
                        </h5>
                        <a href="{{ url_for('main.journal_history') }}" class="btn btn-outline-primary btn-sm">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_entries %}
                        {% for entry in recent_entries %}
                        <div class="journal-entry-preview mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="fw-bold mb-1">
                                        Psalm {{ entry.psalm.number if entry.psalm else entry.psalm_id }}
                                    </h6>
                                    <small class="text-muted">
                                        {% if entry.created_at %}
                                            {% if entry.created_at is string %}
                                                {{ entry.created_at[:10] }}
                                            {% else %}
                                                {{ entry.created_at.strftime('%B %d, %Y') }}
                                            {% endif %}
                                        {% endif %}
                                    </small>
                                </div>
                                <a href="{{ url_for('main.view_journal_entry', entry_id=entry.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    View Entry
                                </a>
                            </div>
                            <p class="text-muted mb-0">
                                {% set content = entry.prompt_responses.values()|list|join(' ') %}
                                {{ content[:120] }}{% if content|length > 120 %}...{% endif %}
                            </p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-journal-whills fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No journal entries yet. Start by reading today's Psalm!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Active Prayers -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-hands text-primary me-2"></i>
                            Active Prayers
                        </h5>
                        <a href="{{ url_for('main.prayers') }}" class="btn btn-sm btn-outline-primary">
                            View All
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if active_prayers %}
                        {% for prayer in active_prayers %}
                        <div class="prayer-item mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="fw-bold mb-1">{{ prayer.title }}</h6>
                                    <span class="badge bg-light text-dark mb-2">{{ prayer.category.title() }}</span>
                                    {% if prayer.description %}
                                    <p class="small text-muted mb-0">
                                        {{ prayer.description[:60] }}{% if prayer.description|length > 60 %}...{% endif %}
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-hands fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-3">No active prayers yet.</p>
                            <a href="{{ url_for('main.prayers') }}" class="btn btn-primary btn-sm">
                                Add Your First Prayer
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js for Heart Tracker -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Heart Tracker emotion data
const emotionTrendsWeek = {{ emotion_trends_week | tojson }};
const emotionTrendsMonth = {{ emotion_trends_month | tojson }};

// Psalm navigation functionality
function navigateToPsalm() {
    const selector = document.getElementById('psalmSelector');
    const psalmNumber = selector.value;
    
    console.log('Selected psalm number:', psalmNumber);
    
    if (psalmNumber && psalmNumber !== '') {
        console.log('Navigating to:', `/reflect/${psalmNumber}?explore=true`);
        // Navigate to pre-reflection page with explore parameter to indicate this is an exploration
        window.location.href = `/reflect/${psalmNumber}?explore=true`;
    } else {
        console.log('No psalm selected');
        alert('Please select a psalm first');
    }
}

// Store chart instances to prevent multiple creation  
let weekChart = null;
let monthChart = null;

// CACHE BUST: 2025-08-27-22:45 - REFLECT ROUTE FIX

// Function to create emotion line chart
function createEmotionChart(canvasId, data, title) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
        console.log(`Canvas ${canvasId} not found`);
        return;
    }
    
    // Always destroy existing chart and clear the canvas
    if (canvasId === 'weekChart' && weekChart) {
        weekChart.destroy();
        weekChart = null;
    } else if (canvasId === 'monthChart' && monthChart) {
        monthChart.destroy();
        monthChart = null;
    }
    
    // Clear the canvas completely
    ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
    
    console.log(`Creating chart for ${canvasId} with data:`, data);
    
    if (!data || data.length === 0) {
        console.log(`No data available for ${canvasId}`);
        return;
    }
    
    // Process data for chart - ensure clean date labels only
    const chartData = {
        labels: data.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }),
        datasets: [{
            label: 'Heart Condition', 
            data: data.map(item => item.value),
            borderColor: '#E93C02',
            backgroundColor: 'rgba(233, 60, 2, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: '#E93C02',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    };
    
    try {
        const chartInstance = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 10,
                        right: 10,
                        bottom: 30,
                        left: 70
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const emotions = ['', 'Awful', 'Bad', 'Okay', 'Good', 'Great'];
                                return `${emotions[context.raw]}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 0.5,
                        max: 5.5,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                const emotions = {
                                    1: 'Awful',
                                    2: 'Bad', 
                                    3: 'Okay',
                                    4: 'Good',
                                    5: 'Great'
                                };
                                return emotions[Math.round(value)] || '';
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 11
                            },
                            maxRotation: 0
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                }
            }
        });
        
        // Store the chart instance
        if (canvasId === 'weekChart') {
            weekChart = chartInstance;
        } else if (canvasId === 'monthChart') {
            monthChart = chartInstance;
        }
        
        console.log(`Successfully created chart for ${canvasId}`);
    } catch (error) {
        console.error(`Error creating chart for ${canvasId}:`, error);
    }
}

// Add some interactive elements to the dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Animate stat cards on page load
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.transform = 'translateY(0)';
            card.style.opacity = '1';
        }, index * 100);
    });
    
    // Initialize Heart Tracker charts if data exists
    console.log('Emotion trends week:', emotionTrendsWeek);
    console.log('Emotion trends month:', emotionTrendsMonth);
    
    if (emotionTrendsWeek && emotionTrendsWeek.length > 0) {
        setTimeout(() => createEmotionChart('weekChart', emotionTrendsWeek, 'This Week'), 100);
    } else {
        console.log('No week emotion data available');
    }
    
    if (emotionTrendsMonth && emotionTrendsMonth.length > 0) {
        setTimeout(() => createEmotionChart('monthChart', emotionTrendsMonth, 'This Month'), 200);
    } else {
        console.log('No month emotion data available');
    }
});
</script>
{% endblock %}

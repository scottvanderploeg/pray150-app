{% extends "base.html" %}

{% block title %}Reset Password - Pray150{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h2 class="fw-bold text-primary">Reset Your Password</h2>
                        <p class="text-muted">Follow these steps to reset your password</p>
                    </div>

                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Password Reset Instructions:</h6>
                        <ol class="mb-0">
                            <li>Check your email for a password reset link from Supabase</li>
                            <li>Click the link in the email (it will open a new tab)</li>
                            <li>Copy the URL from your browser's address bar</li>
                            <li>Paste the URL in the field below and click "Extract Tokens"</li>
                            <li>Enter your new password</li>
                        </ol>
                    </div>

                    <!-- Step 1: Extract tokens from URL -->
                    <div id="step1">
                        <div class="mb-3">
                            <label for="resetUrl" class="form-label">Paste the reset URL from your email here:</label>
                            <textarea class="form-control" id="resetUrl" rows="3" 
                                     placeholder="Paste the full URL from the reset email link here..."></textarea>
                        </div>
                        <button type="button" class="btn btn-secondary w-100 mb-3" id="extractTokensBtn">
                            Extract Tokens from URL
                        </button>
                    </div>

                    <!-- Step 2: Set new password (hidden initially) -->
                    <div id="step2" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>Tokens extracted successfully! Now set your new password.
                        </div>
                        
                        <form id="resetPasswordForm">
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword" name="newPassword" 
                                       minlength="6" required>
                                <div class="form-text">Password must be at least 6 characters long</div>
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                       minlength="6" required>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <span class="spinner-border spinner-border-sm d-none me-2" id="spinner"></span>
                                    Update Password
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="text-center mt-3">
                        <a href="{{ url_for('auth.login') }}" class="text-decoration-none">
                            <i class="fas fa-arrow-left me-1"></i>Back to Login
                        </a>
                    </div>

                    <div id="message" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let extractedTokens = null;

document.getElementById('extractTokensBtn').addEventListener('click', function() {
    const resetUrl = document.getElementById('resetUrl').value.trim();
    const messageDiv = document.getElementById('message');
    
    if (!resetUrl) {
        messageDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Please paste the reset URL from your email.
            </div>
        `;
        return;
    }
    
    try {
        // Extract tokens from URL (they might be in hash or query params)
        let accessToken = null;
        let refreshToken = null;
        
        // Try to get from hash fragment first
        if (resetUrl.includes('#')) {
            const hashPart = resetUrl.split('#')[1];
            const hashParams = new URLSearchParams(hashPart);
            accessToken = hashParams.get('access_token');
            refreshToken = hashParams.get('refresh_token');
        }
        
        // If not in hash, try query parameters
        if (!accessToken && resetUrl.includes('?')) {
            const urlObj = new URL(resetUrl);
            accessToken = urlObj.searchParams.get('access_token');
            refreshToken = urlObj.searchParams.get('refresh_token');
        }
        
        if (accessToken && refreshToken) {
            extractedTokens = {
                access_token: accessToken,
                refresh_token: refreshToken
            };
            
            // Hide step 1, show step 2
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            messageDiv.innerHTML = '';
        } else {
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Could not find valid tokens in the URL. Make sure you copied the complete URL from the reset email.
                </div>
            `;
        }
    } catch (error) {
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Invalid URL format. Please check the URL you pasted.
            </div>
        `;
    }
});

document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const spinner = document.getElementById('spinner');
    const messageDiv = document.getElementById('message');
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Passwords do not match
            </div>
        `;
        return;
    }
    
    if (!extractedTokens) {
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                No tokens found. Please extract tokens from the reset URL first.
            </div>
        `;
        return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    messageDiv.innerHTML = '';
    
    try {
        const response = await fetch('/api/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                access_token: extractedTokens.access_token,
                refresh_token: extractedTokens.refresh_token,
                new_password: newPassword
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            messageDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${result.message} Redirecting to login...
                </div>
            `;
            
            // Redirect to login after success
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    ${result.error || 'Password reset failed'}
                </div>
            `;
        }
    } catch (error) {
        messageDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Network error. Please try again.
            </div>
        `;
    } finally {
        // Hide loading state
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    }
});
</script>
{% endblock %}
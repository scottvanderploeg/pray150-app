{% extends "base.html" %}

{% block title %}Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }} - Pray150{% endblock %}

{% block head %}
<!-- Hebrew Fonts from Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;500;700&family=Noto+Sans+Hebrew:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Quill.js Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Google Fonts for Rich Text Options -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&family=Lora:wght@400;500;600&family=Crimson+Text:wght@400;600&family=Libre+Baskerville:wght@400;700&family=Source+Serif+Pro:wght@400;600&family=Cormorant+Garamond:wght@300;400;500&family=Vollkorn:wght@400;500;600&family=Alegreya:wght@400;500;700&family=Spectral:wght@300;400;500&family=Neuton:wght@300;400;700&family=Linden+Hill:wght@400&family=Cardo:wght@400;700&family=Gentium+Basic:wght@400;700&family=Domine:wght@400;500;600&family=Bitter:wght@300;400;500&family=Arvo:wght@400;700&family=Rokkitt:wght@300;400;500&display=swap" rel="stylesheet">

<style>
    .psalm-text {
        font-family: Georgia, serif;
        line-height: 1.8;
        font-size: 16px;
        text-align: left;
        max-width: 800px;
        margin: 0 auto;
    }
    .verse-number {
        font-size: 14px;
        vertical-align: super;
        line-height: 1;
    }
    .psalm-title {
        font-family: Georgia, serif;
        letter-spacing: 0.5px;
    }
    .highlight {
        background-color: #fff3cd;
        padding: 2px;
        border-radius: 3px;
    }
    .note-marker {
        background-color: #d1ecf1;
        border-left: 3px solid #bee5eb;
        padding: 2px;
        border-radius: 3px;
    }
    
    /* Global Toolbar Styling */
    #global-toolbar {
        position: sticky;
        top: 20px;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #global-toolbar .ql-editor {
        display: none !important;
    }
    
    #global-toolbar .ql-toolbar {
        padding: 3px 4px !important;
        border: 1px solid #ccc;
        border-radius: 3px;
        background: white;
        min-height: 28px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-formats {
        margin-right: 3px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-picker-options,
    #global-toolbar .ql-font-custom,
    #global-toolbar select {
        z-index: 1100 !important;
        position: relative;
    }
    
    #global-toolbar button {
        padding: 1px 3px !important;
        margin: 0 1px !important;
        font-size: 10px !important;
        width: 20px !important;
        height: 20px !important;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #global-toolbar .ql-picker {
        font-size: 10px !important;
    }
    
    #global-toolbar .ql-picker-label {
        padding: 1px 3px !important;
        font-size: 10px !important;
        border: 1px solid #ccc !important;
        border-radius: 3px !important;
        min-height: 18px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-stroke {
        stroke-width: 1.2 !important;
    }
    
    #global-toolbar svg {
        width: 12px !important;
        height: 12px !important;
    }
    
    /* Emotion indicator should not interfere with dropdowns */
    .emotion-indicator {
        z-index: 999 !important;
    }
    
    /* Quill Editor Styling */
    .journal-editor {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-family: Georgia, serif;
        font-size: 16px;
        margin-bottom: 1rem;
    }
    
    .journal-editor .ql-container {
        border-radius: 8px;
        font-size: 16px;
        font-family: Georgia, serif;
        line-height: 1.6;
    }
    
    .journal-editor .ql-editor {
        min-height: 100px;
        font-size: 16px;
        font-family: Georgia, serif;
        line-height: 1.6;
        border-radius: 8px;
    }
    
    .journal-editor .ql-editor.ql-blank::before {
        font-style: normal;
        color: #6c757d;
        font-size: 16px;
        font-family: Georgia, serif;
    }
    
    /* Custom Font Definitions */
    .ql-font-playfair { font-family: 'Playfair Display', serif; }
    .ql-font-merriweather { font-family: 'Merriweather', serif; }
    .ql-font-lora { font-family: 'Lora', serif; }
    .ql-font-crimson { font-family: 'Crimson Text', serif; }
    .ql-font-baskerville { font-family: 'Libre Baskerville', serif; }
    .ql-font-source-serif { font-family: 'Source Serif Pro', serif; }
    .ql-font-cormorant { font-family: 'Cormorant Garamond', serif; }
    .ql-font-vollkorn { font-family: 'Vollkorn', serif; }
    .ql-font-alegreya { font-family: 'Alegreya', serif; }
    .ql-font-spectral { font-family: 'Spectral', serif; }
    .ql-font-neuton { font-family: 'Neuton', serif; }
    .ql-font-linden { font-family: 'Linden Hill', serif; }
    .ql-font-cardo { font-family: 'Cardo', serif; }
    .ql-font-gentium { font-family: 'Gentium Basic', serif; }
    .ql-font-domine { font-family: 'Domine', serif; }
    .ql-font-bitter { font-family: 'Bitter', serif; }
    .ql-font-arvo { font-family: 'Arvo', serif; }
    .ql-font-rokkitt { font-family: 'Rokkitt', serif; }
    .ql-font-georgia { font-family: Georgia, serif; }
    .ql-font-times { font-family: 'Times New Roman', serif; }
    .ql-font-arial { font-family: Arial, sans-serif; }
    .ql-font-helvetica { font-family: 'Helvetica Neue', sans-serif; }
    .ql-font-opensans { font-family: 'Open Sans', sans-serif; }
    .ql-font-roboto { font-family: 'Roboto', sans-serif; }
    
    /* Remove CSS content overrides - using direct text content instead */
    .ql-picker.ql-font .ql-picker-item {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .ql-picker.ql-font .ql-picker-label {
        padding: 4px 8px;
        font-size: 14px;
    }
    
    /* CSS variables for font preview */
    :root {
        --ql-font-playfair: 'Playfair Display', serif;
        --ql-font-merriweather: 'Merriweather', serif;
        --ql-font-lora: 'Lora', serif;
        --ql-font-crimson: 'Crimson Text', serif;
        --ql-font-baskerville: 'Libre Baskerville', serif;
        --ql-font-source-serif: 'Source Serif Pro', serif;
        --ql-font-cormorant: 'Cormorant Garamond', serif;
        --ql-font-vollkorn: 'Vollkorn', serif;
        --ql-font-alegreya: 'Alegreya', serif;
        --ql-font-spectral: 'Spectral', serif;
        --ql-font-neuton: 'Neuton', serif;
        --ql-font-linden: 'Linden Hill', serif;
        --ql-font-cardo: 'Cardo', serif;
        --ql-font-gentium: 'Gentium Basic', serif;
        --ql-font-domine: 'Domine', serif;
        --ql-font-bitter: 'Bitter', serif;
        --ql-font-arvo: 'Arvo', serif;
        --ql-font-rokkitt: 'Rokkitt', serif;
        --ql-font-georgia: Georgia, serif;
        --ql-font-times: 'Times New Roman', serif;
        --ql-font-arial: Arial, sans-serif;
        --ql-font-helvetica: 'Helvetica Neue', sans-serif;
        --ql-font-opensans: 'Open Sans', sans-serif;
        --ql-font-roboto: 'Roboto', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Psalm Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="psalm-header">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" style="color: #766659;">Dashboard</a></li>
                        <li class="breadcrumb-item active" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h1 class="h2 fw-bold mb-2" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </h1>
                        {% if psalm_api_data %}
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge" style="background-color: #E93C02; color: white;">
                                    {{ psalm_api_data.translation }}
                                </span>
                                <small class="text-muted">
                                    {{ psalm_api_data.translation_name }} • {{ psalm_api_data.verse_count }} verses
                                </small>
                            </div>
                            {% if psalm_api_data.superscript %}
                            <div class="mt-2">
                                <small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;">
                                    {{ psalm_api_data.superscript }}
                                </small>
                            </div>
                            {% endif %}
                        {% elif psalm %}
                            <h2 class="h4 text-muted mb-0">{{ psalm.title }}</h2>
                        {% endif %}
                    </div>
                    <!-- Translation Selector and Font Controls -->
                    {% if available_translations %}
                    <div class="translation-controls">
                        <div class="d-flex flex-column gap-2">
                            <!-- Translation Selector -->
                            <div>
                                <label class="form-label small text-muted mb-1">Bible Translation:</label>
                                <select class="form-select form-select-sm" id="translationSelect" onchange="changeTranslation()">
                                    {% for code, name in available_translations.items() %}
                                    <option value="{{ code }}" {% if code == user_translation %}selected{% endif %}>
                                        {{ code }} - {{ name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Font Size Controls -->
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label small text-muted mb-0">Font Size:</label>
                                <div class="d-flex align-items-center gap-1">
                                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="adjustFontSize(-2)" title="Decrease font size">
                                        <i class="fas fa-minus" style="font-size: 10px;"></i>
                                    </button>
                                    <span id="fontSizeDisplay" class="mx-2 text-muted small" style="min-width: 35px; text-align: center;">16px</span>
                                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="adjustFontSize(2)" title="Increase font size">
                                        <i class="fas fa-plus" style="font-size: 10px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Psalm Content -->
        <div class="col-lg-8">
            <!-- Psalm Text -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #333E4D;">
                            <i class="fas fa-book-open me-2" style="color: #E93C02;"></i>
                            Scripture Text
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="psalm-text" id="psalmText" data-psalm-number="{{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}" data-psalm-id="{{ psalm.id if psalm else psalm_number }}" data-base-font-size="16" style="font-family: Georgia, serif; font-size: 16px; line-height: 1.8; max-width: 800px; margin: 0 auto;">
                        {% if psalm_api_data %}
                            <!-- Live Bible API Content -->
                            {% for verse in psalm_api_data.verses %}
                            <div class="verse mb-3" data-verse="{{ verse.verse_number }}" data-verse-id="{{ verse.verse_id }}">
                                <span class="verse-number me-2" style="color: #E93C02; font-weight: bold; font-size: 14px; vertical-align: super;">
                                    {{ verse.verse_number }}
                                </span>
                                <span class="verse-text" style="color: #333E4D;">{{ verse.text|replace('Selah', '<span class="selah">Selah</span>')|safe }}</span>
                            </div>
                            {% endfor %}
                        {% elif psalm %}
                            <!-- Fallback Static Content -->
                            <div class="psalm-text-fallback">
                                {% if psalm.text_niv %}
                                    <div style="color: #333E4D;">{{ psalm.text_niv | safe }}</div>
                                {% else %}
                                    <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                                        <div class="text-muted">Loading psalm text...</div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Markup Tools -->
                    <div class="markup-tools mt-3 pt-3 border-top">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <!-- Highlighter Options -->
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-warning" id="highlightBtn" data-color="yellow">
                                    <i class="fas fa-highlighter me-1"></i>Highlight
                                </button>
                                <button type="button" class="btn btn-sm dropdown-toggle dropdown-toggle-split btn-outline-warning" data-bs-toggle="dropdown">
                                    <span class="visually-hidden">Highlighter Colors</span>
                                </button>
                                <ul class="dropdown-menu" style="z-index: 1500;">
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="yellow">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: yellow; border: 1px solid #ccc;"></span>Yellow
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightgreen">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightgreen; border: 1px solid #ccc;"></span>Green
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightblue">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightblue; border: 1px solid #ccc;"></span>Blue
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightpink">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightpink; border: 1px solid #ccc;"></span>Pink
                                    </a></li>
                                </ul>
                            </div>
                            
                            <button type="button" class="btn btn-sm btn-outline-info" id="noteBtn">
                                <i class="fas fa-sticky-note me-1"></i>Add Note
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleMarkupsBtn">
                                <i class="fas fa-eye-slash me-1"></i>Hide Markups
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music Player -->
            <div class="card border-0 shadow-sm mb-4 today-psalm-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 text-gray-800">
                        <i class="fas fa-music text-blue-600 me-2"></i>
                        Worship Along
                    </h5>
                    <div id="youtube-container" class="ratio ratio-16x9" style="max-width: 800px; margin: 0 auto;">
                        <div class="d-flex justify-content-center align-items-center bg-light rounded" style="height: 100%;" id="youtube-placeholder">
                            <div class="text-muted">Loading worship music...</div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- Journal Prompts Sidebar -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-journal-whills text-primary me-2"></i>
                        Journal Prompts
                    </h5>
                    <!-- Global Formatting Toolbar -->
                    <div id="global-toolbar" class="mb-3" style="border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;"></div>
                </div>
                <div class="card-body">
                    <form id="journalForm" data-psalm-id="{{ psalm.id if psalm else psalm_number }}">
                        <!-- Prompt 1 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">1. Lord, where is my heart/soul today?</h6>
                            {% set emotion_data = pre_reflection_data.emotion if pre_reflection_data else (entries_dict.values() | list | first).prompt_responses.get('emotion') if entries_dict and (entries_dict.values() | list | first).prompt_responses else None %}
                            {% if emotion_data %}
                                <!-- Show emotion context -->
                                <div class="alert alert-info p-3 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-heart me-1"></i>
                                        Your reflection: <strong class="text-capitalize">{{ emotion_data if emotion_data != 'terrible' else 'awful' }}</strong>
                                        <img src="{{ url_for('static', filename='images/emoji-' + emotion_data + '.png') }}" 
                                             alt="{{ emotion_data|title }}" 
                                             style="width: 32px; height: 32px; margin-left: 6px; vertical-align: middle;">
                                    </small>
                                </div>
                            {% endif %}
                            <div class="journal-editor" data-prompt="1" data-placeholder="Reflect on where your heart and soul are today..." style="height: 120px;">{% if pre_reflection_data %}{{ pre_reflection_data.journal_text }}{% elif entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('1', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                        </div>

                        <!-- Prompt 2 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">2. LOOK! Lord, help me discover new truth from your Word today.</h6>
                            <div class="journal-editor" data-prompt="2" data-placeholder="What is the Psalm saying? What is this Psalm about?" style="height: 120px;">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('2', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                        </div>

                        <!-- Prompt 3 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">3. LISTEN! Lord, what is your thought for me today from your Word?</h6>
                            <div class="journal-editor" data-prompt="3" data-placeholder="What is God speaking to you through this Psalm?" style="height: 120px;">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('3', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                        </div>

                        <!-- Prompt 4 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">4. RESPOND: Lord, what do I need to talk to you about? What are you calling me to do?</h6>
                            <div class="journal-editor" data-prompt="4" data-placeholder="How will you respond to God? What action is He calling you to take?" style="height: 120px;">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('4', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                        </div>
                        
                        <!-- Auto-save status -->
                        <div class="text-center">
                            <small id="saveStatus" class="text-muted">Auto-saving...</small>
                        </div>
                    </form>
                    
                    <!-- Complete Psalm Button -->
                    <div class="mt-4 text-center">
                        <form method="POST" action="{{ url_for('main.complete_psalm') }}">
                            <input type="hidden" name="psalm_number" value="{{ psalm_number }}">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check me-2"></i>Complete Psalm
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalLabel">Add Your Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Adding note to: <strong id="selectedTextPreview"></strong></p>
                <div class="mb-3">
                    <label for="noteTextInput" class="form-label">Your thoughts and insights:</label>
                    <textarea class="form-control" id="noteTextInput" rows="4" placeholder="What is God speaking to you through this text? What insights or memories come to mind?"></textarea>
                </div>
                <div class="alert alert-info" id="editNoteHelp" style="display: none;">
                    <small><i class="fas fa-info-circle me-1"></i>Click on any underlined note to edit it.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">Save Note</button>
                <button type="button" class="btn btn-outline-danger" id="deleteNoteBtn" style="display: none;">Delete Note</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/psalm.js') }}"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    // Translation switching functionality
    function changeTranslation() {
        const select = document.getElementById('translationSelect');
        if (!select) return;
        
        const newTranslation = select.value;
        const psalmNumber = document.getElementById('psalmText').dataset.psalmNumber;
        
        if (newTranslation && psalmNumber) {
            // Show loading state
            const psalmText = document.getElementById('psalmText');
            psalmText.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                    <div class="spinner-border" style="color: #E93C02;" role="status">
                        <span class="visually-hidden">Loading ${newTranslation} translation...</span>
                    </div>
                </div>
            `;
            
            // Fetch new translation
            fetch(`/api/psalms/${psalmNumber}?translation=${newTranslation}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePsalmContent(data.data);
                        updatePageTitle(data.data);
                    } else {
                        console.error('Error fetching psalm:', data.error);
                        psalmText.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to load ${newTranslation} translation. Please try again.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Network error:', error);
                    psalmText.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Network error loading translation. Please check your connection.
                        </div>
                    `;
                });
        }
    }
    
    function updatePsalmContent(psalmData) {
        const psalmText = document.getElementById('psalmText');
        let html = '';
        
        psalmData.verses.forEach(verse => {
            // Style "Selah" in the verse text
            const styledText = styleSelahText(verse.text);
            
            // Determine styling for Hebrew, Greek, and English texts
            const isHebrew = psalmData.translation === 'WLC';
            const isGreek = psalmData.translation === 'LXX';
            const isOriginalLanguage = isHebrew || isGreek;
            
            const textDirection = isHebrew ? 'rtl' : 'ltr';
            const textAlign = isHebrew ? 'text-align: right;' : 'text-align: left;';
            const verseNumberPosition = isHebrew ? 'ms-2' : 'me-2';
            const verseNumberFloat = isHebrew ? 'float: right; margin-left: 8px; margin-right: 0;' : '';
            
            const fontFamily = isHebrew ? 'Frank Ruhl Libre, Noto Sans Hebrew, SBL Hebrew, serif' : 
                              isGreek ? 'SBL Greek, Times, serif' : 
                              'Georgia, serif';
            
            // Get current font size from the psalm text container
            const psalmContainer = document.getElementById('psalmText');
            const currentFontSize = parseInt(psalmContainer.style.fontSize) || parseInt(psalmContainer.dataset.baseFontSize) || 16;
            const baseFontSize = isOriginalLanguage ? Math.max(18, currentFontSize) : currentFontSize;
            const verseNumberSize = Math.max(12, Math.round(baseFontSize * 0.875));
            
            html += `
                <div class="verse mb-3" data-verse="${verse.verse_number}" data-verse-id="${verse.verse_id}" style="direction: ${textDirection}; ${textAlign}">
                    <span class="verse-number ${verseNumberPosition}" style="color: #E93C02; font-weight: bold; font-size: ${verseNumberSize}px; vertical-align: super; ${verseNumberFloat}">
                        ${verse.verse_number}
                    </span>
                    <span class="verse-text" style="color: #333E4D; font-family: ${fontFamily}; font-size: ${baseFontSize}px; line-height: ${isOriginalLanguage ? '1.8' : '1.6'};">${styledText}</span>
                </div>
            `;
        });
        
        psalmText.innerHTML = html;
    }
    
    function styleSelahText(text) {
        // Replace "Selah" (case insensitive) with styled version
        return text.replace(/\bSelah\b/gi, '<span class="selah">Selah</span>');
    }
    
    function updatePageTitle(psalmData) {
        // Update the page title and header
        document.title = `Psalm ${psalmData.psalm_number} - Pray150`;
        
        // Update the translation badge if it exists
        const translationBadge = document.querySelector('.badge');
        if (translationBadge) {
            translationBadge.textContent = psalmData.translation;
        }
        
        // Update verse count info
        const verseInfo = document.querySelector('small.text-muted');
        if (verseInfo) {
            verseInfo.textContent = `${psalmData.translation_name} • ${psalmData.verse_count} verses`;
        }
        
        // Update or add superscript
        let superscriptElement = document.querySelector('.psalm-superscript');
        const superscriptContainer = document.querySelector('.d-flex.align-items-center.gap-2').parentElement;
        
        if (psalmData.superscript) {
            if (!superscriptElement) {
                const superscriptDiv = document.createElement('div');
                superscriptDiv.className = 'mt-2';
                superscriptDiv.innerHTML = `<small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;"></small>`;
                superscriptContainer.appendChild(superscriptDiv);
                superscriptElement = superscriptDiv.querySelector('.psalm-superscript');
            }
            superscriptElement.textContent = psalmData.superscript;
        } else {
            if (superscriptElement) {
                superscriptElement.parentElement.remove();
            }
        }
    }
    
    // Font size adjustment functionality
    let currentFontSize = 16; // Default font size
    
    function adjustFontSize(change) {
        const psalmText = document.getElementById('psalmText');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        
        if (!psalmText || !fontSizeDisplay) return;
        
        // Get current font size or use default
        if (currentFontSize === 16) {
            const currentStyle = window.getComputedStyle(psalmText).fontSize;
            currentFontSize = parseInt(currentStyle) || 16;
        }
        
        // Apply change within reasonable limits
        const newSize = Math.max(12, Math.min(32, currentFontSize + change));
        currentFontSize = newSize;
        
        // Update display
        fontSizeDisplay.textContent = newSize + 'px';
        psalmText.style.fontSize = newSize + 'px';
        
        // Update all verse text and numbers proportionally
        const verses = psalmText.querySelectorAll('.verse');
        verses.forEach(verse => {
            const verseText = verse.querySelector('.verse-text');
            const verseNumber = verse.querySelector('.verse-number');
            
            if (verseText) {
                // Check if this is Hebrew or Greek text for larger base size
                const isOriginalLang = verseText.style.fontFamily.includes('Frank Ruhl Libre') || 
                                     verseText.style.fontFamily.includes('SBL Greek');
                const adjustedSize = isOriginalLang ? Math.max(18, newSize) : newSize;
                verseText.style.fontSize = adjustedSize + 'px';
            }
            
            if (verseNumber) {
                verseNumber.style.fontSize = Math.max(12, Math.round(newSize * 0.875)) + 'px';
            }
        });
        
        // Save user preference to localStorage
        localStorage.setItem('pray150_fontSize', newSize);
    }
    
    // Initialize font size display on page load
    document.addEventListener('DOMContentLoaded', function() {
        const psalmText = document.getElementById('psalmText');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        
        if (psalmText && fontSizeDisplay) {
            // Get saved font size from user preference or use default
            const savedSize = localStorage.getItem('pray150_fontSize');
            if (savedSize) {
                const size = parseInt(savedSize);
                if (size >= 12 && size <= 32) {
                    currentFontSize = size;
                    psalmText.style.fontSize = size + 'px';
                    fontSizeDisplay.textContent = size + 'px';
                }
            } else {
                const currentStyle = window.getComputedStyle(psalmText).fontSize;
                currentFontSize = parseInt(currentStyle) || 16;
                fontSizeDisplay.textContent = currentFontSize + 'px';
            }
        }
    });
    
    // Load YouTube video for worship music
    function loadYouTubeVideo() {
        const psalmNumber = {{ psalm_number }};
        const youtubeContainer = document.getElementById('youtube-container');
        const placeholder = document.getElementById('youtube-placeholder');
        
        if (!youtubeContainer || !placeholder) return;
        
        // Load psalm music configuration from server
        fetch(`/api/psalm-music/${psalmNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.video_id) {
                    loadPsalmVideo(data.video_id, data.alternates || []);
                } else {
                    showPlaylistFallback();
                }
            })
            .catch(error => {
                console.log('No specific music configured, showing playlist fallback');
                showPlaylistFallback();
            });
    }
    
    function loadPsalmVideo(primaryVideoId, alternateVideoIds = []) {
        const youtubeContainer = document.getElementById('youtube-container');
        const placeholder = document.getElementById('youtube-placeholder');
        
        if (!youtubeContainer || !placeholder) return;
        
        // Create iframe for primary video
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${primaryVideoId}?rel=0&modestbranding=1&iv_load_policy=3&cc_load_policy=0&showinfo=0`;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        
        // Replace placeholder with iframe
        youtubeContainer.removeChild(placeholder);
        youtubeContainer.appendChild(iframe);
        
        // If there are alternate videos, show them below
        if (alternateVideoIds.length > 0) {
            const alternatesContainer = document.createElement('div');
            alternatesContainer.className = 'mt-3';
            alternatesContainer.innerHTML = `
                <div class="text-center">
                    <small class="text-muted">Additional worship songs for this psalm:</small>
                    <div class="mt-2">
                        ${alternateVideoIds.map((videoId, index) => 
                            `<a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" class="btn btn-outline-secondary btn-sm me-2 mb-1">
                                <i class="fab fa-youtube me-1"></i>Song ${index + 2}
                            </a>`
                        ).join('')}
                    </div>
                </div>
            `;
            youtubeContainer.parentNode.appendChild(alternatesContainer);
        }
    }
    
    function showPlaylistFallback() {
        const placeholder = document.getElementById('youtube-placeholder');
        if (!placeholder) return;
        
        const psalmNumber = {{ psalm_number }};
        
        // Show link to the full playlist when no specific video is configured
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-music text-muted mb-3" style="font-size: 2rem;"></i>
                <div class="text-muted mb-3">No specific worship music configured for Psalm ${psalmNumber}</div>
                <a href="https://youtube.com/playlist?list=PLlAZONCUO1iQr2m19nFmRLyTWdey-iXuh" 
                   target="_blank" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="fab fa-youtube me-2"></i>
                    Open Full Psalm Playlist
                </a>
                <div class="mt-2">
                    <small class="text-muted">Browse the complete collection and worship along!</small>
                </div>
            </div>
        `;
        

    }
    
    // Call loadYouTubeVideo when page loads
    document.addEventListener('DOMContentLoaded', loadYouTubeVideo);
    
    function applySimpleFormat(formatType, color) {
        console.log('Simple format function called:', formatType, color);
        
        // Find all Quill editor elements on the page
        const quillEditors = document.querySelectorAll('.ql-editor');
        console.log('Found', quillEditors.length, 'Quill editors on page');
        
        let activeEditor = null;
        
        // Check each editor for focus or selection
        quillEditors.forEach((editorElement, index) => {
            console.log('Checking editor', index + 1);
            
            // Try to get the Quill instance from the parent container
            let quillInstance = null;
            let parent = editorElement.parentElement;
            
            // Look for Quill instance in various ways
            if (parent.__quill) {
                quillInstance = parent.__quill;
                console.log('Found Quill instance via __quill property');
            } else if (window.Quill && window.Quill.find) {
                quillInstance = window.Quill.find(editorElement);
                console.log('Found Quill instance via Quill.find');
            } else {
                // Try to find in global quillInstances if available
                if (typeof window.quillInstances !== 'undefined') {
                    Object.values(window.quillInstances).forEach(quill => {
                        if (quill.root === editorElement) {
                            quillInstance = quill;
                            console.log('Found Quill instance in global quillInstances');
                        }
                    });
                }
            }
            
            if (quillInstance) {
                try {
                    const selection = quillInstance.getSelection();
                    console.log('Editor', index + 1, 'selection:', selection);
                    
                    if (selection && selection.length > 0) {
                        activeEditor = quillInstance;
                        console.log('Editor', index + 1, 'has text selection - using this one');
                        return; // Found editor with selection, use it
                    } else if (selection && selection.length === 0 && !activeEditor) {
                        // Editor has cursor focus (selection with length 0)
                        activeEditor = quillInstance;
                        console.log('Editor', index + 1, 'has cursor focus - using this one');
                    } else if (quillInstance.hasFocus() && !activeEditor) {
                        activeEditor = quillInstance;
                        console.log('Editor', index + 1, 'has focus - potential candidate');
                    }
                } catch (e) {
                    console.log('Error checking editor', index + 1, ':', e);
                }
            } else {
                console.log('Could not find Quill instance for editor', index + 1);
            }
        });
        
        if (activeEditor) {
            try {
                const currentSelection = activeEditor.getSelection();
                console.log('Using active editor with selection:', currentSelection);
                
                if (currentSelection && currentSelection.length > 0) {
                    // Apply formatting to selection
                    activeEditor.format(formatType, color);
                    console.log('Applied', formatType, ':', color, 'to selected text');
                } else {
                    // Set formatting for future typing at cursor position
                    activeEditor.format(formatType, color);
                    console.log('Set', formatType, ':', color, 'for future typing');
                    
                    // Give user feedback
                    const colorName = color.charAt(0).toUpperCase() + color.slice(1);
                    const formatName = formatType === 'background' ? 'highlight' : 'text color';
                    
                    // Briefly show a small indicator
                    const indicator = document.createElement('div');
                    indicator.textContent = `${colorName} ${formatName} active`;
                    indicator.style.cssText = `
                        position: fixed; 
                        top: 20px; 
                        right: 20px; 
                        background: ${color}; 
                        color: ${formatType === 'background' ? 'black' : 'white'}; 
                        padding: 5px 10px; 
                        border-radius: 4px; 
                        font-size: 12px; 
                        z-index: 1000;
                        ${formatType === 'background' ? 'border: 1px solid #333;' : ''}
                    `;
                    document.body.appendChild(indicator);
                    
                    // Remove indicator after 2 seconds
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.parentNode.removeChild(indicator);
                        }
                    }, 2000);
                }
            } catch (e) {
                console.error('Error applying format:', e);
                alert('Error applying formatting: ' + e.message);
            }
        } else {
            console.log('No active Quill editor found');
            alert('Please click in a journal response box and select some text, then try the color button again.');
        }
    }
</script>

<!-- Quill.js Rich Text Editor -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
{% endblock %}

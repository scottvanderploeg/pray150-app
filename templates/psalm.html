{% extends "base.html" %}

{% block title %}Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }} - Pray150{% endblock %}

{% block head %}
<!-- Hebrew Fonts from Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;500;700&family=Noto+Sans+Hebrew:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Custom Rich Text Editor Styles -->

<!-- Google Fonts for Rich Text Options -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Merriweather:wght@300;400;700&family=Lora:wght@400;500;600&family=Crimson+Text:wght@400;600&family=Libre+Baskerville:wght@400;700&family=Source+Serif+Pro:wght@400;600&family=Cormorant+Garamond:wght@300;400;500&family=Vollkorn:wght@400;500;600&family=Alegreya:wght@400;500;700&family=Spectral:wght@300;400;500&family=Neuton:wght@300;400;700&family=Linden+Hill:wght@400&family=Cardo:wght@400;700&family=Gentium+Basic:wght@400;700&family=Domine:wght@400;500;600&family=Bitter:wght@300;400;500&family=Arvo:wght@400;700&family=Rokkitt:wght@300;400;500&display=swap" rel="stylesheet">

<style>
    .psalm-text {
        font-family: Georgia, serif;
        line-height: 1.8;
        font-size: 16px;
        text-align: left;
        max-width: 800px;
        margin: 0 auto;
    }
    .verse-number {
        font-size: 14px;
        vertical-align: super;
        line-height: 1;
    }
    .psalm-title {
        font-family: Georgia, serif;
        letter-spacing: 0.5px;
    }
    .highlight {
        background-color: #fff3cd;
        padding: 2px;
        border-radius: 3px;
    }
    .note-marker {
        background-color: #d1ecf1;
        border-left: 3px solid #bee5eb;
        padding: 2px;
        border-radius: 3px;
    }
    
    /* Global Toolbar Styling */
    #global-toolbar {
        position: sticky;
        top: 20px;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #global-toolbar .ql-editor {
        display: none !important;
    }
    
    #global-toolbar .ql-toolbar {
        padding: 3px 4px !important;
        border: 1px solid #ccc;
        border-radius: 3px;
        background: white;
        min-height: 28px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-formats {
        margin-right: 3px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-picker-options,
    #global-toolbar .ql-font-custom,
    #global-toolbar select {
        z-index: 1100 !important;
        position: relative;
    }
    
    #global-toolbar button {
        padding: 1px 3px !important;
        margin: 0 1px !important;
        font-size: 10px !important;
        width: 20px !important;
        height: 20px !important;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    #global-toolbar .ql-picker {
        font-size: 10px !important;
    }
    
    #global-toolbar .ql-picker-label {
        padding: 1px 3px !important;
        font-size: 10px !important;
        border: 1px solid #ccc !important;
        border-radius: 3px !important;
        min-height: 18px !important;
        display: flex;
        align-items: center;
    }
    
    #global-toolbar .ql-stroke {
        stroke-width: 1.2 !important;
    }
    
    #global-toolbar svg {
        width: 12px !important;
        height: 12px !important;
    }
    
    /* Emotion indicator should not interfere with dropdowns */
    .emotion-indicator {
        z-index: 999 !important;
    }
    
    /* Custom Rich Text Editor Styling */
    .custom-editor {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-family: Georgia, serif;
        font-size: 16px;
        margin-bottom: 1rem;
        background: white;
        position: relative;
    }
    
    .custom-editor-toolbar {
        border-bottom: 1px solid #dee2e6;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .custom-editor-content {
        min-height: 100px;
        font-family: Georgia, serif;
        font-size: 16px;
        line-height: 1.6;
        padding: 12px;
        border-radius: 0 0 8px 8px;
        outline: none;
        cursor: text;
    }
    
    .custom-editor-content:empty::before {
        content: attr(data-placeholder);
        color: #6c757d;
        font-style: normal;
        pointer-events: none;
        font-family: Georgia, serif;
        font-size: 16px;
    }
    
    .format-btn {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 12px;
        color: #555;
        display: flex;
        align-items: center;
        gap: 4px;
        min-width: 28px;
        height: 28px;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .format-btn:hover {
        background: #f0f0f0;
        border-color: #999;
    }
    
    .format-btn.active {
        background: #e0e0e0;
        border-color: #666;
    }
    
    .format-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .format-dropdown-content {
        display: none;
        position: absolute;
        top: 32px;
        left: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        z-index: 1000;
        min-width: 120px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .format-dropdown-content.show {
        display: block;
    }
    
    .color-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
    }
    
    .color-option {
        width: 24px;
        height: 24px;
        border: 1px solid #999;
        border-radius: 3px;
        cursor: pointer;
        transition: transform 0.1s;
    }
    
    .color-option:hover {
        transform: scale(1.1);
        border-color: #333;
    }
    
    .size-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 4px;
    }
    
    .size-option {
        padding: 4px 8px;
        background: white;
        border: 1px solid #999;
        border-radius: 3px;
        cursor: pointer;
        text-align: center;
        transition: background 0.1s;
        font-size: var(--option-size);
    }
    
    .size-option:hover {
        background: #f0f0f0;
    }
    
    /* Custom Font Definitions */
    .ql-font-playfair { font-family: 'Playfair Display', serif; }
    .ql-font-merriweather { font-family: 'Merriweather', serif; }
    .ql-font-lora { font-family: 'Lora', serif; }
    .ql-font-crimson { font-family: 'Crimson Text', serif; }
    .ql-font-baskerville { font-family: 'Libre Baskerville', serif; }
    .ql-font-source-serif { font-family: 'Source Serif Pro', serif; }
    .ql-font-cormorant { font-family: 'Cormorant Garamond', serif; }
    .ql-font-vollkorn { font-family: 'Vollkorn', serif; }
    .ql-font-alegreya { font-family: 'Alegreya', serif; }
    .ql-font-spectral { font-family: 'Spectral', serif; }
    .ql-font-neuton { font-family: 'Neuton', serif; }
    .ql-font-linden { font-family: 'Linden Hill', serif; }
    .ql-font-cardo { font-family: 'Cardo', serif; }
    .ql-font-gentium { font-family: 'Gentium Basic', serif; }
    .ql-font-domine { font-family: 'Domine', serif; }
    .ql-font-bitter { font-family: 'Bitter', serif; }
    .ql-font-arvo { font-family: 'Arvo', serif; }
    .ql-font-rokkitt { font-family: 'Rokkitt', serif; }
    .ql-font-georgia { font-family: Georgia, serif; }
    .ql-font-times { font-family: 'Times New Roman', serif; }
    .ql-font-arial { font-family: Arial, sans-serif; }
    .ql-font-helvetica { font-family: 'Helvetica Neue', sans-serif; }
    .ql-font-opensans { font-family: 'Open Sans', sans-serif; }
    .ql-font-roboto { font-family: 'Roboto', sans-serif; }
    
    /* Remove CSS content overrides - using direct text content instead */
    .ql-picker.ql-font .ql-picker-item {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .ql-picker.ql-font .ql-picker-label {
        padding: 4px 8px;
        font-size: 14px;
    }
    
    /* CSS variables for font preview */
    :root {
        --ql-font-playfair: 'Playfair Display', serif;
        --ql-font-merriweather: 'Merriweather', serif;
        --ql-font-lora: 'Lora', serif;
        --ql-font-crimson: 'Crimson Text', serif;
        --ql-font-baskerville: 'Libre Baskerville', serif;
        --ql-font-source-serif: 'Source Serif Pro', serif;
        --ql-font-cormorant: 'Cormorant Garamond', serif;
        --ql-font-vollkorn: 'Vollkorn', serif;
        --ql-font-alegreya: 'Alegreya', serif;
        --ql-font-spectral: 'Spectral', serif;
        --ql-font-neuton: 'Neuton', serif;
        --ql-font-linden: 'Linden Hill', serif;
        --ql-font-cardo: 'Cardo', serif;
        --ql-font-gentium: 'Gentium Basic', serif;
        --ql-font-domine: 'Domine', serif;
        --ql-font-bitter: 'Bitter', serif;
        --ql-font-arvo: 'Arvo', serif;
        --ql-font-rokkitt: 'Rokkitt', serif;
        --ql-font-georgia: Georgia, serif;
        --ql-font-times: 'Times New Roman', serif;
        --ql-font-arial: Arial, sans-serif;
        --ql-font-helvetica: 'Helvetica Neue', sans-serif;
        --ql-font-opensans: 'Open Sans', sans-serif;
        --ql-font-roboto: 'Roboto', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Psalm Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="psalm-header">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" style="color: #766659;">Dashboard</a></li>
                        <li class="breadcrumb-item active" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h1 class="h2 fw-bold mb-2" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </h1>
                        {% if psalm_api_data %}
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge" style="background-color: #E93C02; color: white;">
                                    {{ psalm_api_data.translation }}
                                </span>
                                <small class="text-muted">
                                    {{ psalm_api_data.translation_name }} • {{ psalm_api_data.verse_count }} verses
                                </small>
                            </div>
                            {% if psalm_api_data.superscript %}
                            <div class="mt-2">
                                <small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;">
                                    {{ psalm_api_data.superscript }}
                                </small>
                            </div>
                            {% endif %}
                        {% elif psalm %}
                            <h2 class="h4 text-muted mb-0">{{ psalm.title }}</h2>
                        {% endif %}
                    </div>
                    <!-- Translation Selector and Font Controls -->
                    {% if available_translations %}
                    <div class="translation-controls">
                        <div class="d-flex flex-column gap-2">
                            <!-- Translation Selector -->
                            <div>
                                <label class="form-label small text-muted mb-1">Bible Translation:</label>
                                <select class="form-select form-select-sm" id="translationSelect" onchange="changeTranslation()">
                                    {% for code, name in available_translations.items() %}
                                    <option value="{{ code }}" {% if code == user_translation %}selected{% endif %}>
                                        {{ code }} - {{ name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- Font Size Controls -->
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label small text-muted mb-0">Font Size:</label>
                                <div class="d-flex align-items-center gap-1">
                                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="adjustFontSize(-2)" title="Decrease font size">
                                        <i class="fas fa-minus" style="font-size: 10px;"></i>
                                    </button>
                                    <span id="fontSizeDisplay" class="mx-2 text-muted small" style="min-width: 35px; text-align: center;">16px</span>
                                    <button class="btn btn-outline-secondary btn-sm py-0 px-2" onclick="adjustFontSize(2)" title="Increase font size">
                                        <i class="fas fa-plus" style="font-size: 10px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Psalm Content -->
        <div class="col-lg-8">
            <!-- Psalm Text -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #333E4D;">
                            <i class="fas fa-book-open me-2" style="color: #E93C02;"></i>
                            Scripture Text
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="psalm-text" id="psalmText" data-psalm-number="{{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}" data-psalm-id="{{ psalm.id if psalm else psalm_number }}" data-base-font-size="16" style="font-family: Georgia, serif; font-size: 16px; line-height: 1.8; max-width: 800px; margin: 0 auto;">
                        {% if psalm_api_data %}
                            <!-- Live Bible API Content -->
                            {% for verse in psalm_api_data.verses %}
                            <div class="verse mb-3" data-verse="{{ verse.verse_number }}" data-verse-id="{{ verse.verse_id }}">
                                <span class="verse-number me-2" style="color: #E93C02; font-weight: bold; font-size: 14px; vertical-align: super;">
                                    {{ verse.verse_number }}
                                </span>
                                <span class="verse-text" style="color: #333E4D;">{{ verse.text|replace('Selah', '<span class="selah">Selah</span>')|safe }}</span>
                            </div>
                            {% endfor %}
                        {% elif psalm %}
                            <!-- Fallback Static Content -->
                            <div class="psalm-text-fallback">
                                {% if psalm.text_niv %}
                                    <div style="color: #333E4D;">{{ psalm.text_niv | safe }}</div>
                                {% else %}
                                    <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                                        <div class="text-muted">Loading psalm text...</div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Markup Tools -->
                    <div class="markup-tools mt-3 pt-3 border-top">
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <!-- Highlighter Options -->
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-warning" id="highlightBtn" data-color="yellow">
                                    <i class="fas fa-highlighter me-1"></i>Highlight
                                </button>
                                <button type="button" class="btn btn-sm dropdown-toggle dropdown-toggle-split btn-outline-warning" data-bs-toggle="dropdown">
                                    <span class="visually-hidden">Highlighter Colors</span>
                                </button>
                                <ul class="dropdown-menu" style="z-index: 1500;">
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="yellow">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: yellow; border: 1px solid #ccc;"></span>Yellow
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightgreen">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightgreen; border: 1px solid #ccc;"></span>Green
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightblue">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightblue; border: 1px solid #ccc;"></span>Blue
                                    </a></li>
                                    <li><a class="dropdown-item highlight-color-option" href="#" data-color="lightpink">
                                        <span class="d-inline-block me-2 rounded" style="width: 16px; height: 16px; background-color: lightpink; border: 1px solid #ccc;"></span>Pink
                                    </a></li>
                                </ul>
                            </div>
                            
                            <button type="button" class="btn btn-sm btn-outline-info" id="noteBtn">
                                <i class="fas fa-sticky-note me-1"></i>Add Note
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleMarkupsBtn">
                                <i class="fas fa-eye-slash me-1"></i>Hide Markups
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music Player -->
            <div class="card border-0 shadow-sm mb-4 today-psalm-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 text-gray-800">
                        <i class="fas fa-music text-blue-600 me-2"></i>
                        Worship Along
                    </h5>
                    <div id="youtube-container" class="ratio ratio-16x9" style="max-width: 800px; margin: 0 auto;">
                        <div class="d-flex justify-content-center align-items-center bg-light rounded" style="height: 100%;" id="youtube-placeholder">
                            <div class="text-muted">Loading worship music...</div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <!-- Journal Prompts Sidebar -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-journal-whills text-primary me-2"></i>
                        Journal Prompts
                    </h5>
                    
                    <!-- Global Formatting Toolbar -->
                    <div class="global-toolbar mb-4">
                        <div class="custom-editor-toolbar" style="border-radius: 8px; border: 1px solid #dee2e6;">
                            <button class="format-btn" onmousedown="event.preventDefault(); formatText('bold')" data-format="bold" title="Bold">
                                <strong>B</strong>
                            </button>
                            <button class="format-btn" onmousedown="event.preventDefault(); formatText('italic')" data-format="italic" title="Italic">
                                <em>I</em>
                            </button>
                            <button class="format-btn" onmousedown="event.preventDefault(); formatText('underline')" data-format="underline" title="Underline">
                                <u>U</u>
                            </button>
                            <button class="format-btn" onmousedown="event.preventDefault(); formatText('strikethrough')" data-format="strikethrough" title="Strikethrough">
                                <s>S</s>
                            </button>
                            
                            <div class="format-dropdown">
                                <button class="format-btn" onmousedown="event.preventDefault(); toggleDropdown('global-color')" title="Text Color">
                                    <span style="color: #000;">A</span> ▼
                                </button>
                                <div id="global-color" class="format-dropdown-content">
                                    <div class="color-grid">
                                        <div class="color-option" style="background: black;" onmousedown="event.preventDefault(); formatText('foreColor', 'black')" title="Black"></div>
                                        <div class="color-option" style="background: red;" onmousedown="event.preventDefault(); formatText('foreColor', 'red')" title="Red"></div>
                                        <div class="color-option" style="background: blue;" onmousedown="event.preventDefault(); formatText('foreColor', 'blue')" title="Blue"></div>
                                        <div class="color-option" style="background: green;" onmousedown="event.preventDefault(); formatText('foreColor', 'green')" title="Green"></div>
                                        <div class="color-option" style="background: purple;" onmousedown="event.preventDefault(); formatText('foreColor', 'purple')" title="Purple"></div>
                                        <div class="color-option" style="background: orange;" onmousedown="event.preventDefault(); formatText('foreColor', 'orange')" title="Orange"></div>
                                        <div class="color-option" style="background: brown;" onmousedown="event.preventDefault(); formatText('foreColor', 'brown')" title="Brown"></div>
                                        <div class="color-option" style="background: darkblue;" onmousedown="event.preventDefault(); formatText('foreColor', 'darkblue')" title="Dark Blue"></div>
                                        <div class="color-option" style="background: darkgreen;" onmousedown="event.preventDefault(); formatText('foreColor', 'darkgreen')" title="Dark Green"></div>
                                        <div class="color-option" style="background: darkred;" onmousedown="event.preventDefault(); formatText('foreColor', 'darkred')" title="Dark Red"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="format-dropdown">
                                <button class="format-btn" onmousedown="event.preventDefault(); toggleDropdown('global-highlight')" title="Highlight">
                                    <span style="background: yellow; padding: 2px;">H</span> ▼
                                </button>
                                <div id="global-highlight" class="format-dropdown-content">
                                    <div class="color-grid">
                                        <div class="color-option" style="background: yellow;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'yellow')" title="Yellow"></div>
                                        <div class="color-option" style="background: lightblue;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'lightblue')" title="Light Blue"></div>
                                        <div class="color-option" style="background: lightgreen;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'lightgreen')" title="Light Green"></div>
                                        <div class="color-option" style="background: pink;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'pink')" title="Pink"></div>
                                        <div class="color-option" style="background: lightyellow;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'lightyellow')" title="Light Yellow"></div>
                                        <div class="color-option" style="background: transparent; border: 2px solid #999;" onmousedown="event.preventDefault(); formatText('hiliteColor', 'transparent')" title="Remove Highlight"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="format-dropdown">
                                <button class="format-btn" onmousedown="event.preventDefault(); toggleDropdown('global-size')" title="Font Size">
                                    Size ▼
                                </button>
                                <div id="global-size" class="format-dropdown-content">
                                    <div class="size-grid">
                                        <div class="size-option" style="--option-size: 10px;" onmousedown="event.preventDefault(); formatText('fontSize', '10px')">10px</div>
                                        <div class="size-option" style="--option-size: 12px;" onmousedown="event.preventDefault(); formatText('fontSize', '12px')">12px</div>
                                        <div class="size-option" style="--option-size: 14px;" onmousedown="event.preventDefault(); formatText('fontSize', '14px')">14px</div>
                                        <div class="size-option" style="--option-size: 16px;" onmousedown="event.preventDefault(); formatText('fontSize', '16px')">16px</div>
                                        <div class="size-option" style="--option-size: 18px;" onmousedown="event.preventDefault(); formatText('fontSize', '18px')">18px</div>
                                        <div class="size-option" style="--option-size: 20px;" onmousedown="event.preventDefault(); formatText('fontSize', '20px')">20px</div>
                                        <div class="size-option" style="--option-size: 24px;" onmousedown="event.preventDefault(); formatText('fontSize', '24px')">24px</div>
                                        <div class="size-option" style="--option-size: 28px;" onmousedown="event.preventDefault(); formatText('fontSize', '28px')">28px</div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form id="journalForm" data-psalm-id="{{ psalm.id if psalm else psalm_number }}">
                        <!-- Prompt 1 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">1. Lord, where is my heart/soul today?</h6>
                            {% set emotion_data = pre_reflection_data.emotion if pre_reflection_data else (entries_dict.values() | list | first).prompt_responses.get('emotion') if entries_dict and (entries_dict.values() | list | first).prompt_responses else None %}
                            {% if emotion_data %}
                                <!-- Show emotion context -->
                                <div class="alert alert-info p-3 mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-heart me-1"></i>
                                        Your reflection: <strong class="text-capitalize">{{ emotion_data if emotion_data != 'terrible' else 'awful' }}</strong>
                                        <img src="{{ url_for('static', filename='images/emoji-' + emotion_data + '.png') }}" 
                                             alt="{{ emotion_data|title }}" 
                                             style="width: 32px; height: 32px; margin-left: 6px; vertical-align: middle;">
                                    </small>
                                </div>
                            {% endif %}
                            <div class="custom-editor" data-prompt="1">
                                <div class="custom-editor-content" contenteditable="true" data-placeholder="Reflect on where your heart and soul are today..." data-prompt="1">{% if pre_reflection_data %}{{ pre_reflection_data.journal_text }}{% elif entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('1', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                            </div>
                        </div>

                        <!-- Prompt 2 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">2. LOOK! Lord, help me discover new truth from your Word today.</h6>
                            <div class="custom-editor" data-prompt="2">
                                <div class="custom-editor-content" contenteditable="true" data-placeholder="What is the Psalm saying? What is this Psalm about?" data-prompt="2">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('2', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                            </div>
                        </div>

                        <!-- Prompt 3 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">3. LISTEN! Lord, what is your thought for me today from your Word?</h6>
                            <div class="custom-editor" data-prompt="3">
                                <div class="custom-editor-content" contenteditable="true" data-placeholder="What is God speaking to you through this Psalm?" data-prompt="3">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('3', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                            </div>
                        </div>

                        <!-- Prompt 4 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">4. RESPOND: Lord, what do I need to talk to you about? What are you calling me to do?</h6>
                            <div class="custom-editor" data-prompt="4">
                                <div class="custom-editor-content" contenteditable="true" data-placeholder="How will you respond to God? What action is He calling you to take?" data-prompt="4">{% if entries_dict %}{% set entry = entries_dict.values() | list | first %}{{ entry.prompt_responses.get('4', '') | safe if entry and entry.prompt_responses else '' }}{% endif %}</div>
                            </div>
                        </div>
                        
                        <!-- Auto-save status removed - using custom editor auto-save now -->
                    </form>
                    
                    <!-- Complete Psalm Button -->
                    <div class="mt-4 text-center">
                        <form method="POST" action="{{ url_for('main.complete_psalm') }}">
                            <input type="hidden" name="psalm_number" value="{{ psalm_number }}">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check me-2"></i>Complete Psalm
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalLabel">Add Your Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Adding note to: <strong id="selectedTextPreview"></strong></p>
                <div class="mb-3">
                    <label for="noteTextInput" class="form-label">Your thoughts and insights:</label>
                    <textarea class="form-control" id="noteTextInput" rows="4" placeholder="What is God speaking to you through this text? What insights or memories come to mind?"></textarea>
                </div>
                <div class="alert alert-info" id="editNoteHelp" style="display: none;">
                    <small><i class="fas fa-info-circle me-1"></i>Click on any underlined note to edit it.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">Save Note</button>
                <button type="button" class="btn btn-outline-danger" id="deleteNoteBtn" style="display: none;">Delete Note</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/custom-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    // Bible text highlighting and note functionality
    document.addEventListener('DOMContentLoaded', function() {
        const psalmText = document.getElementById('psalmText');
        const highlightBtn = document.getElementById('highlightBtn');
        const noteBtn = document.getElementById('noteBtn');
        const toggleMarkupsBtn = document.getElementById('toggleMarkupsBtn');
        let currentHighlightColor = 'yellow';
        let markupsVisible = true;
        let isHighlightMode = false;
        let isNoteMode = false;
        
        // Initialize markup tools
        if (highlightBtn) {
            highlightBtn.addEventListener('click', function() {
                toggleHighlightMode();
            });
        }
        
        // Color options
        const colorOptions = document.querySelectorAll('.highlight-color-option');
        colorOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                currentHighlightColor = this.getAttribute('data-color');
                highlightBtn.setAttribute('data-color', currentHighlightColor);
                toggleHighlightMode();
            });
        });
        
        if (noteBtn) {
            noteBtn.addEventListener('click', function() {
                toggleNoteMode();
            });
        }
        
        if (toggleMarkupsBtn) {
            toggleMarkupsBtn.addEventListener('click', function() {
                toggleMarkupsVisibility();
            });
        }
        
        function toggleHighlightMode() {
            isHighlightMode = !isHighlightMode;
            isNoteMode = false;
            
            if (isHighlightMode) {
                highlightBtn.textContent = 'Click text to highlight';
                highlightBtn.classList.add('active');
                noteBtn.classList.remove('active');
                psalmText.style.cursor = 'crosshair';
            } else {
                highlightBtn.innerHTML = '<i class="fas fa-highlighter me-1"></i>Highlight';
                highlightBtn.classList.remove('active');
                psalmText.style.cursor = 'default';
            }
        }
        
        function toggleNoteMode() {
            isNoteMode = !isNoteMode;
            isHighlightMode = false;
            
            if (isNoteMode) {
                noteBtn.textContent = 'Click text to add note';
                noteBtn.classList.add('active');
                highlightBtn.classList.remove('active');
                psalmText.style.cursor = 'crosshair';
            } else {
                noteBtn.innerHTML = '<i class="fas fa-sticky-note me-1"></i>Add Note';
                noteBtn.classList.remove('active');
                psalmText.style.cursor = 'default';
            }
        }
        
        function toggleMarkupsVisibility() {
            markupsVisible = !markupsVisible;
            const markups = document.querySelectorAll('.markup-highlight, .markup-note');
            
            markups.forEach(markup => {
                if (markupsVisible) {
                    markup.style.backgroundColor = markup.getAttribute('data-original-color') || 'yellow';
                    markup.style.display = 'inline';
                } else {
                    markup.style.backgroundColor = 'transparent';
                }
            });
            
            toggleMarkupsBtn.innerHTML = markupsVisible 
                ? '<i class="fas fa-eye-slash me-1"></i>Hide Markups'
                : '<i class="fas fa-eye me-1"></i>Show Markups';
        }
        
        // Handle text selection for highlighting and notes
        if (psalmText) {
            psalmText.addEventListener('mouseup', function(e) {
                const selection = window.getSelection();
                if (selection.toString().length > 0) {
                    const selectedText = selection.toString().trim();
                    
                    if (isHighlightMode && selectedText) {
                        highlightSelectedText(selection, selectedText);
                        clearSelection();
                        toggleHighlightMode();
                    } else if (isNoteMode && selectedText) {
                        addNoteToSelectedText(selection, selectedText);
                        clearSelection();
                        toggleNoteMode();
                    }
                }
            });
        }
        
        function highlightSelectedText(selection, text) {
            try {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'markup-highlight';
                span.style.backgroundColor = currentHighlightColor;
                span.setAttribute('data-original-color', currentHighlightColor);
                span.title = `Highlighted in ${currentHighlightColor}`;
                
                try {
                    range.surroundContents(span);
                    saveMarkup(text, 'highlight', currentHighlightColor);
                } catch(e) {
                    // If surroundContents fails, extract and wrap content
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                    saveMarkup(text, 'highlight', currentHighlightColor);
                }
            } catch(error) {
                console.error('Error highlighting text:', error);
                window.Pray150?.showNotification('Error highlighting text. Please try again.', 'error');
            }
        }
        
        function addNoteToSelectedText(selection, text) {
            const note = prompt('Add your note:');
            if (note && note.trim()) {
                try {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'markup-note';
                    span.style.backgroundColor = 'lightcyan';
                    span.style.borderBottom = '2px dotted #007bff';
                    span.title = note.trim();
                    span.setAttribute('data-note', note.trim());
                    
                    try {
                        range.surroundContents(span);
                        saveMarkup(text, 'note', null, note.trim());
                    } catch(e) {
                        const contents = range.extractContents();
                        span.appendChild(contents);
                        range.insertNode(span);
                        saveMarkup(text, 'note', null, note.trim());
                    }
                } catch(error) {
                    console.error('Error adding note:', error);
                    window.Pray150?.showNotification('Error adding note. Please try again.', 'error');
                }
            }
        }
        
        function saveMarkup(text, type, color, note) {
            const psalmId = psalmText.getAttribute('data-psalm-id') || psalmText.getAttribute('data-psalm-number');
            const markupData = {
                psalm_id: parseInt(psalmId),
                markup_type: type,
                text: text,
                color: color,
                note_text: note,
                translation: 'NIV'
            };
            
            fetch('/save_markup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(markupData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.Pray150?.showNotification(`${type === 'highlight' ? 'Highlight' : 'Note'} saved successfully!`, 'success');
                } else {
                    console.error('Failed to save markup:', data.error);
                }
            })
            .catch(error => {
                console.error('Error saving markup:', error);
            });
        }
        
        function clearSelection() {
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
        }
        
        // Load existing markups - wait for content to load
        const waitForContent = () => {
            const psalmTextContent = psalmText?.textContent || '';
            if (psalmTextContent.trim().length > 0) {
                loadMarkups();
            } else {
                setTimeout(waitForContent, 200);
            }
        };
        
        setTimeout(waitForContent, 100);
        
        function loadMarkups() {
            const psalmId = psalmText?.getAttribute('data-psalm-id') || psalmText?.getAttribute('data-psalm-number');
            if (!psalmId) return;
            
            fetch(`/get_markups/${psalmId}?translation=NIV`)
                .then(response => response.json())
                .then(data => {
                    if (data.markups && data.markups.length > 0) {
                        applyMarkups(data.markups);
                    }
                })
                .catch(error => console.error('Error loading markups:', error));
        }
        
        function applyMarkups(markups) {
            markups.forEach((markup, index) => {
                const markupData = markup['markup-data'] || markup.markup_data || markup;
                if (markupData && markupData.text) {
                    applyMarkupToText(markupData);
                }
            });
        }
        
        function applyMarkupToText(markupData) {
            const textToFind = markupData.text;
            const psalmTextElement = document.getElementById('psalmText');
            if (!psalmTextElement) return;
            
            let htmlContent = psalmTextElement.innerHTML;
            
            // Only apply if the text hasn't already been marked up
            if (htmlContent.includes(`data-markup-text="${textToFind}"`)) {
                return;
            }
            
            // Find and replace the text with marked up version
            const textPattern = textToFind.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape regex chars
            const regex = new RegExp(`(${textPattern})`, 'gi');
            
            if (htmlContent.match(regex)) {
                let replacementSpan;
                if (markupData.markup_type === 'highlight') {
                    const color = markupData.color || 'yellow';
                    replacementSpan = `<span class="markup-highlight" style="background-color: ${color};" data-original-color="${color}" title="Highlighted in ${color}" data-markup-text="${textToFind}">$1</span>`;
                } else if (markupData.markup_type === 'note') {
                    const noteText = markupData.note_text || markupData.note || 'Note';
                    replacementSpan = `<span class="markup-note" style="background-color: lightcyan; border-bottom: 2px dotted #007bff;" title="${noteText}" data-note="${noteText}" data-markup-text="${textToFind}">$1</span>`;
                }
                
                // Replace first occurrence only
                const updatedContent = htmlContent.replace(regex, replacementSpan);
                if (updatedContent !== htmlContent) {
                    psalmTextElement.innerHTML = updatedContent;
                }
            }
        }
    });

    // Translation switching functionality
    function changeTranslation() {
        const select = document.getElementById('translationSelect');
        if (!select) return;
        
        const newTranslation = select.value;
        const psalmNumber = document.getElementById('psalmText').dataset.psalmNumber;
        
        if (newTranslation && psalmNumber) {
            // Show loading state
            const psalmText = document.getElementById('psalmText');
            psalmText.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                    <div class="spinner-border" style="color: #E93C02;" role="status">
                        <span class="visually-hidden">Loading ${newTranslation} translation...</span>
                    </div>
                </div>
            `;
            
            // Fetch new translation
            fetch(`/api/psalms/${psalmNumber}?translation=${newTranslation}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePsalmContent(data.data);
                        updatePageTitle(data.data);
                    } else {
                        console.error('Error fetching psalm:', data.error);
                        psalmText.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to load ${newTranslation} translation. Please try again.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Network error:', error);
                    psalmText.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Network error loading translation. Please check your connection.
                        </div>
                    `;
                });
        }
    }
    
    function updatePsalmContent(psalmData) {
        const psalmText = document.getElementById('psalmText');
        let html = '';
        
        psalmData.verses.forEach(verse => {
            // Style "Selah" in the verse text
            const styledText = styleSelahText(verse.text);
            
            // Determine styling for Hebrew, Greek, and English texts
            const isHebrew = psalmData.translation === 'WLC';
            const isGreek = psalmData.translation === 'LXX';
            const isOriginalLanguage = isHebrew || isGreek;
            
            const textDirection = isHebrew ? 'rtl' : 'ltr';
            const textAlign = isHebrew ? 'text-align: right;' : 'text-align: left;';
            const verseNumberPosition = isHebrew ? 'ms-2' : 'me-2';
            const verseNumberFloat = isHebrew ? 'float: right; margin-left: 8px; margin-right: 0;' : '';
            
            const fontFamily = isHebrew ? 'Frank Ruhl Libre, Noto Sans Hebrew, SBL Hebrew, serif' : 
                              isGreek ? 'SBL Greek, Times, serif' : 
                              'Georgia, serif';
            
            // Get current font size from the psalm text container
            const psalmContainer = document.getElementById('psalmText');
            const currentFontSize = parseInt(psalmContainer.style.fontSize) || parseInt(psalmContainer.dataset.baseFontSize) || 16;
            const baseFontSize = isOriginalLanguage ? Math.max(18, currentFontSize) : currentFontSize;
            const verseNumberSize = Math.max(12, Math.round(baseFontSize * 0.875));
            
            html += `
                <div class="verse mb-3" data-verse="${verse.verse_number}" data-verse-id="${verse.verse_id}" style="direction: ${textDirection}; ${textAlign}">
                    <span class="verse-number ${verseNumberPosition}" style="color: #E93C02; font-weight: bold; font-size: ${verseNumberSize}px; vertical-align: super; ${verseNumberFloat}">
                        ${verse.verse_number}
                    </span>
                    <span class="verse-text" style="color: #333E4D; font-family: ${fontFamily}; font-size: ${baseFontSize}px; line-height: ${isOriginalLanguage ? '1.8' : '1.6'};">${styledText}</span>
                </div>
            `;
        });
        
        psalmText.innerHTML = html;
    }
    
    function styleSelahText(text) {
        // Replace "Selah" (case insensitive) with styled version
        return text.replace(/\bSelah\b/gi, '<span class="selah">Selah</span>');
    }
    
    function updatePageTitle(psalmData) {
        // Update the page title and header
        document.title = `Psalm ${psalmData.psalm_number} - Pray150`;
        
        // Update the translation badge if it exists
        const translationBadge = document.querySelector('.badge');
        if (translationBadge) {
            translationBadge.textContent = psalmData.translation;
        }
        
        // Update verse count info
        const verseInfo = document.querySelector('small.text-muted');
        if (verseInfo) {
            verseInfo.textContent = `${psalmData.translation_name} • ${psalmData.verse_count} verses`;
        }
        
        // Update or add superscript
        let superscriptElement = document.querySelector('.psalm-superscript');
        const superscriptContainer = document.querySelector('.d-flex.align-items-center.gap-2').parentElement;
        
        if (psalmData.superscript) {
            if (!superscriptElement) {
                const superscriptDiv = document.createElement('div');
                superscriptDiv.className = 'mt-2';
                superscriptDiv.innerHTML = `<small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;"></small>`;
                superscriptContainer.appendChild(superscriptDiv);
                superscriptElement = superscriptDiv.querySelector('.psalm-superscript');
            }
            superscriptElement.textContent = psalmData.superscript;
        } else {
            if (superscriptElement) {
                superscriptElement.parentElement.remove();
            }
        }
    }
    
    // Font size adjustment functionality
    let currentFontSize = 16; // Default font size
    
    function adjustFontSize(change) {
        const psalmText = document.getElementById('psalmText');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        
        if (!psalmText || !fontSizeDisplay) return;
        
        // Get current font size or use default
        if (currentFontSize === 16) {
            const currentStyle = window.getComputedStyle(psalmText).fontSize;
            currentFontSize = parseInt(currentStyle) || 16;
        }
        
        // Apply change within reasonable limits
        const newSize = Math.max(12, Math.min(32, currentFontSize + change));
        currentFontSize = newSize;
        
        // Update display
        fontSizeDisplay.textContent = newSize + 'px';
        psalmText.style.fontSize = newSize + 'px';
        
        // Update all verse text and numbers proportionally
        const verses = psalmText.querySelectorAll('.verse');
        verses.forEach(verse => {
            const verseText = verse.querySelector('.verse-text');
            const verseNumber = verse.querySelector('.verse-number');
            
            if (verseText) {
                // Check if this is Hebrew or Greek text for larger base size
                const isOriginalLang = verseText.style.fontFamily.includes('Frank Ruhl Libre') || 
                                     verseText.style.fontFamily.includes('SBL Greek');
                const adjustedSize = isOriginalLang ? Math.max(18, newSize) : newSize;
                verseText.style.fontSize = adjustedSize + 'px';
            }
            
            if (verseNumber) {
                verseNumber.style.fontSize = Math.max(12, Math.round(newSize * 0.875)) + 'px';
            }
        });
        
        // Save user preference to localStorage
        localStorage.setItem('pray150_fontSize', newSize);
    }
    
    // Initialize font size display on page load
    document.addEventListener('DOMContentLoaded', function() {
        const psalmText = document.getElementById('psalmText');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        
        if (psalmText && fontSizeDisplay) {
            // Get saved font size from user preference or use default
            const savedSize = localStorage.getItem('pray150_fontSize');
            if (savedSize) {
                const size = parseInt(savedSize);
                if (size >= 12 && size <= 32) {
                    currentFontSize = size;
                    psalmText.style.fontSize = size + 'px';
                    fontSizeDisplay.textContent = size + 'px';
                }
            } else {
                const currentStyle = window.getComputedStyle(psalmText).fontSize;
                currentFontSize = parseInt(currentStyle) || 16;
                fontSizeDisplay.textContent = currentFontSize + 'px';
            }
        }
    });
    
    // Load YouTube video for worship music
    function loadYouTubeVideo() {
        const psalmNumber = {{ psalm_number }};
        const youtubeContainer = document.getElementById('youtube-container');
        const placeholder = document.getElementById('youtube-placeholder');
        
        if (!youtubeContainer || !placeholder) return;
        
        // Load psalm music configuration from server
        fetch(`/api/psalm-music/${psalmNumber}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.video_id) {
                    loadPsalmVideo(data.video_id, data.alternates || []);
                } else {
                    showPlaylistFallback();
                }
            })
            .catch(error => {
                console.log('No specific music configured, showing playlist fallback');
                showPlaylistFallback();
            });
    }
    
    function loadPsalmVideo(primaryVideoId, alternateVideoIds = []) {
        const youtubeContainer = document.getElementById('youtube-container');
        const placeholder = document.getElementById('youtube-placeholder');
        
        if (!youtubeContainer || !placeholder) return;
        
        // Create iframe for primary video
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${primaryVideoId}?rel=0&modestbranding=1&iv_load_policy=3&cc_load_policy=0&showinfo=0`;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        
        // Replace placeholder with iframe
        youtubeContainer.removeChild(placeholder);
        youtubeContainer.appendChild(iframe);
        
        // If there are alternate videos, show them below
        if (alternateVideoIds.length > 0) {
            const alternatesContainer = document.createElement('div');
            alternatesContainer.className = 'mt-3';
            alternatesContainer.innerHTML = `
                <div class="text-center">
                    <small class="text-muted">Additional worship songs for this psalm:</small>
                    <div class="mt-2">
                        ${alternateVideoIds.map((videoId, index) => 
                            `<a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" class="btn btn-outline-secondary btn-sm me-2 mb-1">
                                <i class="fab fa-youtube me-1"></i>Song ${index + 2}
                            </a>`
                        ).join('')}
                    </div>
                </div>
            `;
            youtubeContainer.parentNode.appendChild(alternatesContainer);
        }
    }
    
    function showPlaylistFallback() {
        const placeholder = document.getElementById('youtube-placeholder');
        if (!placeholder) return;
        
        const psalmNumber = {{ psalm_number }};
        
        // Show link to the full playlist when no specific video is configured
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-music text-muted mb-3" style="font-size: 2rem;"></i>
                <div class="text-muted mb-3">No specific worship music configured for Psalm ${psalmNumber}</div>
                <a href="https://youtube.com/playlist?list=PLlAZONCUO1iQr2m19nFmRLyTWdey-iXuh" 
                   target="_blank" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="fab fa-youtube me-2"></i>
                    Open Full Psalm Playlist
                </a>
                <div class="mt-2">
                    <small class="text-muted">Browse the complete collection and worship along!</small>
                </div>
            </div>
        `;
        

    }
    
    // Call loadYouTubeVideo when page loads
    document.addEventListener('DOMContentLoaded', loadYouTubeVideo);
</script>

<!-- Custom Rich Text Editor - No external dependencies needed -->
{% endblock %}

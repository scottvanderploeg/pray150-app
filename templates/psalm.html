{% extends "base.html" %}

{% block title %}Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }} - Pray150{% endblock %}

{% block head %}
<style>
    .psalm-text {
        font-family: Georgia, serif;
        line-height: 1.8;
        font-size: 16px;
        text-align: left;
        max-width: 800px;
        margin: 0 auto;
    }
    .verse-number {
        font-size: 14px;
        vertical-align: super;
        line-height: 1;
    }
    .psalm-title {
        font-family: Georgia, serif;
        letter-spacing: 0.5px;
    }
    .highlight {
        background-color: #fff3cd;
        padding: 2px;
        border-radius: 3px;
    }
    .note-marker {
        background-color: #d1ecf1;
        border-left: 3px solid #bee5eb;
        padding: 2px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Psalm Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="psalm-header">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" style="color: #766659;">Dashboard</a></li>
                        <li class="breadcrumb-item active" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h1 class="h2 fw-bold mb-2" style="color: #333E4D;">
                            Psalm {{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}
                        </h1>
                        {% if psalm_api_data %}
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge" style="background-color: #E93C02; color: white;">
                                    {{ psalm_api_data.translation }}
                                </span>
                                <small class="text-muted">
                                    {{ psalm_api_data.translation_name }} • {{ psalm_api_data.verse_count }} verses
                                </small>
                            </div>
                            {% if psalm_api_data.superscript %}
                            <div class="mt-2">
                                <small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;">
                                    {{ psalm_api_data.superscript }}
                                </small>
                            </div>
                            {% endif %}
                        {% elif psalm %}
                            <h2 class="h4 text-muted mb-0">{{ psalm.title }}</h2>
                        {% endif %}
                    </div>
                    <!-- Single Translation Selector -->
                    {% if available_translations %}
                    <div class="translation-controls">
                        <label class="form-label small text-muted mb-1">Bible Translation:</label>
                        <select class="form-select form-select-sm" id="translationSelect" onchange="changeTranslation()">
                            {% for code, name in available_translations.items() %}
                            <option value="{{ code }}" {% if code == user_translation %}selected{% endif %}>
                                {{ code }} - {{ name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Psalm Content -->
        <div class="col-lg-8">
            <!-- Psalm Text -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 pt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #333E4D;">
                            <i class="fas fa-book-open me-2" style="color: #E93C02;"></i>
                            Scripture Text
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="psalm-text" id="psalmText" data-psalm-number="{{ psalm_api_data.psalm_number if psalm_api_data else psalm.number }}" style="font-family: Georgia, serif; font-size: 16px; line-height: 1.8; max-width: 800px; margin: 0 auto;">
                        {% if psalm_api_data %}
                            <!-- Live Bible API Content -->
                            {% for verse in psalm_api_data.verses %}
                            <div class="verse mb-3" data-verse="{{ verse.verse_number }}" data-verse-id="{{ verse.verse_id }}">
                                <span class="verse-number me-2" style="color: #E93C02; font-weight: bold; font-size: 14px; vertical-align: super;">
                                    {{ verse.verse_number }}
                                </span>
                                <span class="verse-text" style="color: #333E4D;">{{ verse.text|replace('Selah', '<span class="selah">Selah</span>')|safe }}</span>
                            </div>
                            {% endfor %}
                        {% elif psalm %}
                            <!-- Fallback Static Content -->
                            <div class="psalm-text-fallback">
                                {% if psalm.text_niv %}
                                    <div style="color: #333E4D;">{{ psalm.text_niv | safe }}</div>
                                {% else %}
                                    <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                                        <div class="text-muted">Loading psalm text...</div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Markup Tools -->
                    <div class="markup-tools mt-3 pt-3 border-top">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-warning" id="highlightBtn">
                                <i class="fas fa-highlighter me-1"></i>Highlight
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" id="noteBtn">
                                <i class="fas fa-sticky-note me-1"></i>Add Note
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleMarkupsBtn">
                                <i class="fas fa-eye me-1"></i>Toggle Markups
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Music Player -->
            <div class="card border-0 shadow-sm mb-4 today-psalm-card">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 text-gray-800">
                        <i class="fas fa-music text-blue-600 me-2"></i>
                        Worship Along
                    </h5>
                    <div id="youtube-container" class="ratio ratio-16x9" style="max-width: 800px; margin: 0 auto;">
                        <div class="d-flex justify-content-center align-items-center bg-light rounded" style="height: 100%;">
                            <div class="text-muted">Loading worship music...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Mark as Complete
                    </h5>
                    <form method="POST" action="{{ url_for('main.complete_psalm') }}">
                        <input type="hidden" name="psalm_id" value="{{ psalm.number }}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="reading_time" class="form-label">Reading time (minutes)</label>
                                <input type="number" class="form-control" id="reading_time" name="reading_time" min="1" max="120">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="music_listened" name="music_listened" value="true">
                                    <label class="form-check-label" for="music_listened">
                                        Listened to worship music
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success mt-3">
                            <i class="fas fa-check me-2"></i>Complete Psalm
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Journal Prompts Sidebar -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-journal-whills text-primary me-2"></i>
                        Journal Prompts
                    </h5>
                </div>
                <div class="card-body">
                    <form id="journalForm" data-psalm-id="{{ psalm.number }}">
                        <!-- Prompt 1 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">1. Lord, where is my heart/soul today?</h6>
                            <textarea class="form-control journal-textarea" data-prompt="1" rows="3" 
                                      placeholder="Reflect on where your heart and soul are today...">{% if entries_dict and entries_dict.values() %}{{ entries_dict.values()|first.prompt_responses.get('1', '') }}{% endif %}</textarea>
                        </div>

                        <!-- Prompt 2 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">2. LOOK! Lord, help me discover new truth from your Word today.</h6>
                            <textarea class="form-control journal-textarea" data-prompt="2" rows="3" 
                                      placeholder="What is the Psalm saying? What is this Psalm about?">{% if entries_dict and entries_dict.values() %}{{ entries_dict.values()|first.prompt_responses.get('2', '') }}{% endif %}</textarea>
                        </div>

                        <!-- Prompt 3 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">3. LISTEN! Lord, what is your thought for me today from your Word?</h6>
                            <textarea class="form-control journal-textarea" data-prompt="3" rows="3" 
                                      placeholder="What is God speaking to you through this Psalm?">{% if entries_dict and entries_dict.values() %}{{ entries_dict.values()|first.prompt_responses.get('3', '') }}{% endif %}</textarea>
                        </div>

                        <!-- Prompt 4 -->
                        <div class="journal-prompt mb-4">
                            <h6 class="fw-bold text-primary">4. RESPOND: Lord, what do I need to talk to you about? What are you calling me to do?</h6>
                            <textarea class="form-control journal-textarea" data-prompt="4" rows="3" 
                                      placeholder="How will you respond to God? What action is He calling you to take?">{% if entries_dict and entries_dict.values() %}{{ entries_dict.values()|first.prompt_responses.get('4', '') }}{% endif %}</textarea>
                        </div>
                        
                        <!-- Auto-save status -->
                        <div class="text-center">
                            <small id="saveStatus" class="text-muted">Auto-saving...</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/psalm.js') }}"></script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
    // Translation switching functionality
    function changeTranslation() {
        const select = document.getElementById('translationSelect');
        if (!select) return;
        
        const newTranslation = select.value;
        const psalmNumber = document.getElementById('psalmText').dataset.psalmNumber;
        
        if (newTranslation && psalmNumber) {
            // Show loading state
            const psalmText = document.getElementById('psalmText');
            psalmText.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                    <div class="spinner-border" style="color: #E93C02;" role="status">
                        <span class="visually-hidden">Loading ${newTranslation} translation...</span>
                    </div>
                </div>
            `;
            
            // Fetch new translation
            fetch(`/api/psalms/${psalmNumber}?translation=${newTranslation}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updatePsalmContent(data.data);
                        updatePageTitle(data.data);
                    } else {
                        console.error('Error fetching psalm:', data.error);
                        psalmText.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to load ${newTranslation} translation. Please try again.
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Network error:', error);
                    psalmText.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Network error loading translation. Please check your connection.
                        </div>
                    `;
                });
        }
    }
    
    function updatePsalmContent(psalmData) {
        const psalmText = document.getElementById('psalmText');
        let html = '';
        
        psalmData.verses.forEach(verse => {
            // Style "Selah" in the verse text
            const styledText = styleSelahText(verse.text);
            
            html += `
                <div class="verse mb-3" data-verse="${verse.verse_number}" data-verse-id="${verse.verse_id}">
                    <span class="verse-number me-2" style="color: #E93C02; font-weight: bold; font-size: 14px; vertical-align: super;">
                        ${verse.verse_number}
                    </span>
                    <span class="verse-text" style="color: #333E4D;">${styledText}</span>
                </div>
            `;
        });
        
        psalmText.innerHTML = html;
    }
    
    function styleSelahText(text) {
        // Replace "Selah" (case insensitive) with styled version
        return text.replace(/\bSelah\b/gi, '<span class="selah">Selah</span>');
    }
    
    function updatePageTitle(psalmData) {
        // Update the page title and header
        document.title = `Psalm ${psalmData.psalm_number} - Pray150`;
        
        // Update the translation badge if it exists
        const translationBadge = document.querySelector('.badge');
        if (translationBadge) {
            translationBadge.textContent = psalmData.translation;
        }
        
        // Update verse count info
        const verseInfo = document.querySelector('small.text-muted');
        if (verseInfo) {
            verseInfo.textContent = `${psalmData.translation_name} • ${psalmData.verse_count} verses`;
        }
        
        // Update or add superscript
        let superscriptElement = document.querySelector('.psalm-superscript');
        const superscriptContainer = document.querySelector('.d-flex.align-items-center.gap-2').parentElement;
        
        if (psalmData.superscript) {
            if (!superscriptElement) {
                const superscriptDiv = document.createElement('div');
                superscriptDiv.className = 'mt-2';
                superscriptDiv.innerHTML = `<small class="psalm-superscript" style="font-style: italic; color: #766659; font-family: Georgia, serif;"></small>`;
                superscriptContainer.appendChild(superscriptDiv);
                superscriptElement = superscriptDiv.querySelector('.psalm-superscript');
            }
            superscriptElement.textContent = psalmData.superscript;
        } else {
            if (superscriptElement) {
                superscriptElement.parentElement.remove();
            }
        }
    }
</script>
{% endblock %}
